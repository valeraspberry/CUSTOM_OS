import random, time

def play():
    # --- DATA PERSISTENCE LAYER ---
    try:
        cash = float(disk.get("CASH.DAT", 1200.0))
        day = int(disk.get("DAY.DAT", 1))
        rep = float(disk.get("REP.DAT", 3.0))
        # Loading dictionary strings from disk
        saved_inv = eval(disk.get("INV.DAT", "{}"))
        active_lics = eval(disk.get("LIC.DAT", "{}"))
    except:
        cash, day, rep = 1200.0, 1, 3.0
        saved_inv, active_lics = {}, {}

    # Format: [Performance, Purchase_Cost, License_Cost, Category]
    db = {
        "i3-12100": [10,80,40,"CPU"], "i5-13600K": [35,300,120,"CPU"],
        "i9-14900K": [80,580,250,"CPU"], "R5-7600": [30,220,90,"CPU"],
        "R7-7800X3D": [55,400,180,"CPU"], "R9-9950X": [95,700,300,"CPU"],
        "TR-7980X": [180,2600,800,"CPU"],
        "GTX-1650": [10,160,50,"GPU"], "RTX-3060": [25,280,100,"GPU"],
        "RTX-4060Ti": [40,400,150,"GPU"], "RTX-4070S": [65,650,250,"GPU"],
        "RTX-4080S": [90,1000,400,"GPU"], "RTX-5090": [150,2200,1000,"GPU"],
        "8GB-D4": [5,40,20,"RAM"], "16GB-D4": [12,75,35,"RAM"],
        "32GB-D5": [25,140,60,"RAM"], "64GB-D5": [45,350,120,"RAM"], "1TB-HDD": [3,40,15,"DISK"],
        "500GB-SSD": [8,50,25,"DISK"], "2TB-NVME": [25,140,55,"DISK"],
        "4TB-NVME": [45,300,100,"DISK"], "H610-MB": [5,70,30,"MB"],        "B760-MB": [15,140,60,"MB"], "Z790-MB": [40,350,140,"MB"],
        "500W-BR": [5,60,30,"PSU"], "750W-GL": [15,120,50,"PSU"],
        "1200W-GL": [50,280,90,"PSU"]
    }

    # Merge saved stock counts into the database
    inv = {k: [saved_inv.get(k, 0)] + v for k, v in db.items()}

    while True:
        stars = "★" * int(rep) + "☆" * (5 - int(rep))
        print(f"\n[ DAY {day} | CASH: {cash:.2f}e | {stars} ]")
        print("1.SHOP 2.BUILD 3.LICENSES 4.NEXT DAY 5.SAVE & QUIT")        sel = input("MAIN> ")

        if sel == "1":
            cats = ["CPU", "GPU", "RAM", "DISK", "MB", "PSU"]
            for i, c in enumerate(cats): print(f"{i+1}.{c}", end=" ")
            c_idx = input("\nCAT#> ")
            t_cat = cats[int(c_idx)-1]
            cat_list = [k for k in inv if inv[k][4] == t_cat]
            for i, k in enumerate(cat_list):
                l = active_lics.get(k, 0)
                print(f"{i+1}. {k} ({inv[k][2]}e) [LIC:{l}d] [STK:{inv[k][0]}]")

            p_idx = input("BUY # (or 0 back)> ")
            if p_idx.isdigit() and int(p_idx) > 0:
                buy = cat_list[int(p_idx)-1]
                if active_lics.get(buy, 0) > 0 and cash >= inv[buy][2]:
                    inv[buy][0] += 1; cash -= inv[buy][2]; print("BOUGHT")
                else: print("LICENSE EXPIRED OR NO CASH")

        elif sel == "2":
            build = []; perf = 0; cost = 0
            for ct in ["CPU", "GPU", "RAM", "DISK", "MB", "PSU"]:
                stock = [k for k in inv if inv[k][4] == ct and inv[k][0] > 0]
                if not stock: print(f"MISSING {ct}!"); break
                for i, s in enumerate(stock): print(f"{i+1}. {s} (Stk:{inv[s][0]})")
                choice = int(input(f"USE {ct} #> "))
                nm = stock[choice-1]
                build.append(nm); perf += inv[nm][1]; cost += inv[nm][2]

            if len(build) == 6:
                price = float(input(f"COST: {cost}. PRICE: "))

                # --- FAIR BUDGET CALCULATION ---
                min_bud = cost * (0.9 + (rep/10))
                max_bud = cost * (1.5 + (rep/2))
                bud = random.randint(int(min_bud), int(max_bud))

                print(f"CUSTOMER BUDGET: {bud}e")

                if price <= bud:
                    print("$$$ SOLD $$$"); cash += price
                    for p in build: inv[p][0] -= 1
                    rep = min(5.0, rep + 0.3)
                else:
                    rep = max(1.0, rep - 0.2); print("CUSTOMER REJECTED")

        elif sel == "3":
            all_parts = list(inv.keys())
            for i, k in enumerate(all_parts): print(f"{i+1}. {k} ({inv[k][3]}e)")
            l_idx = input("LICENSE #> ")
            if l_idx.isdigit():
                l_nm = all_parts[int(l_idx)-1]
                if cash >= inv[l_nm][3]:
                    active_lics[l_nm] = active_lics.get(l_nm, 0) + 7
                    cash -= inv[l_nm][3]; print("LICENSED")

        elif sel == "4":
            day += 1
            for k in list(active_lics.keys()):
                active_lics[k] -= 1
                if active_lics[k] <= 0: del active_lics[k]
            cash -= (50 + day)
            if cash < 0: print("BANKRUPT"); return

        elif sel == "5":
            # Extract just the stock counts to save space
            stock_only = {k: v[0] for k, v in inv.items() if v[0] > 0}
            disk["CASH.DAT"], disk["DAY.DAT"], disk["REP.DAT"] = str(cash), str(day), str(rep)
            disk["INV.DAT"], disk["LIC.DAT"] = str(stock_only), str(active_lics)
            save_to_disk(disk); return

play()
